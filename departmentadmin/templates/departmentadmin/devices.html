{% extends 'departmentadmin/base.html' %}

{% block title %}My Devices - {{ department.name }}{% endblock %}
{% block page_heading %}My Devices{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   DEVICES PAGE - PROFESSIONAL SAAS STYLE
   With User Assignment Feature
   ======================================== */

/* ===== CONTAINER ===== */
.device-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-6);
}

/* ===== WELCOME CARD ===== */
.welcome-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    box-shadow: var(--shadow-sm);
}

.welcome-card h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.welcome-card h3 i {
    color: var(--primary-blue);
    font-size: var(--text-2xl);
}

.welcome-card p {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin: 0;
}

.welcome-card p strong {
    color: var(--primary-blue);
}

.welcome-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
}

.stats-badges {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.stats-badge {
    background: var(--bg-primary);
    border: 2px solid var(--primary-blue);
    color: var(--primary-blue);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
}

.stats-badge i {
    color: var(--primary-blue);
}

.stats-badge.active {
    border-color: var(--success);
    color: var(--success);
}

.stats-badge.active i {
    color: var(--success);
}

.stats-badge.inactive {
    border-color: var(--danger);
    color: var(--danger);
}

.stats-badge.inactive i {
    color: var(--danger);
}

/* ===== SECTION HEADER ===== */
.devices-section {
    margin-bottom: var(--space-6);
}

.section-header {
    background: var(--bg-primary);
    border-left: 4px solid var(--primary-blue);
    border: 1px solid var(--border-light);
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
}

.section-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin: 0;
}

.section-title i {
    color: var(--primary-blue);
    font-size: var(--text-xl);
}

.section-badge {
    background: var(--gray-100);
    color: var(--text-primary);
    padding: 4px var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
}

/* ===== DEVICE CARDS GRID ===== */
.device-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-4);
}

/* ===== DEVICE CARD ===== */
.device-card {
    background: var(--bg-primary);
    border: 1px solid var(--primary-blue);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-sm);
}

.device-card:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

/* Inactive device styling */
.device-card.inactive {
    border-color: var(--danger);
    opacity: 0.7;
}

.device-card.inactive:hover {
    border-color: var(--danger);
    opacity: 1;
}

.device-card-header {
    background: var(--gray-50);
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-light);
}

.device-card-header.inactive {
    background: rgba(239, 68, 68, 0.05);
}

.device-title {
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.device-title i {
    color: var(--primary-blue);
    font-size: var(--text-lg);
}

.device-title.inactive i {
    color: var(--danger);
}

.device-id-label {
    font-size: 11px;
    color: var(--text-tertiary);
    font-family: 'Courier New', monospace;
    background: var(--bg-tertiary);
    padding: 3px var(--space-2);
    border-radius: var(--radius-sm);
    display: inline-block;
}

.device-card-body {
    padding: var(--space-4);
}

/* ===== DEVICE INFO ===== */
.device-info-compact {
    display: grid;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.device-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--text-sm);
}

.device-info-label {
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.device-info-label i {
    width: 16px;
    text-align: center;
}

.device-info-label i.fa-power-off {
    color: var(--success);
}

.device-info-label i.fa-tag {
    color: var(--warning);
}

.device-info-label i.fa-database {
    color: var(--info);
}

.device-info-label i.fa-chart-line {
    color: var(--warning);
}

.device-info-label i.fa-users {
    color: var(--primary-blue);
}

/* ===== DEVICE BADGES ===== */
.device-badge {
    padding: 3px var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
}

.device-badge.active {
    background: var(--success);
    color: white;
}

.device-badge.inactive {
    background: var(--danger);
    color: white;
}

.device-badge.sensor-count {
    background: var(--info);
    color: white;
}

.device-badge.user-count {
    background: var(--primary-blue);
    color: white;
}

.device-badge.no-users {
    background: var(--gray-400);
    color: white;
}

/* ===== DEVICE TYPE BADGES ===== */
.device-type-badge {
    padding: 4px var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.device-type-badge.industrial_sensor {
    background: #e3f2fd;
    color: #1565c0;
}

.device-type-badge.asset_tracking {
    background: #fff3e0;
    color: #e65100;
}

.device-type-badge.not-set {
    background: var(--gray-200);
    color: var(--text-muted);
}

/* ===== ACTION BUTTONS - 3 COLUMNS ===== */
.device-actions-compact {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-light);
}

.device-btn-compact {
    padding: var(--space-2) var(--space-2);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    text-decoration: none;
}

.device-btn-compact:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.device-btn-graph-active {
    background: var(--warning);
    color: white;
}

.device-btn-graph-active:hover {
    background: #d97706;
    color: white;
}

.device-btn-graph-active i {
    color: white;
}

.device-btn-sensors {
    background: var(--primary-blue);
    color: white;
}

.device-btn-sensors:hover {
    background: var(--primary-blue-dark);
    color: white;
}

.device-btn-sensors i {
    color: white;
}

.device-btn-assign {
    background: var(--success);
    color: white;
}

.device-btn-assign:hover {
    background: #059669;
    color: white;
}

.device-btn-assign i {
    color: white;
}

/* Disabled buttons */
.device-btn-compact:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.device-btn-compact:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* ===== MODAL STYLES ===== */
.modal-header {
    background: var(--primary-blue);
    color: white;
    border-bottom: none;
    padding: var(--space-5);
}

.modal-header.assign-header {
    background: var(--success);
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.modal-header .modal-title {
    font-weight: 600;
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.modal-header .modal-title i {
    color: white;
}

.modal-xl {
    max-width: 1200px;
}

.modal-body {
    padding: var(--space-6);
}

.modal-footer {
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--border-light);
}

.modal-footer .btn i {
    color: inherit;
}

/* ===== ASSIGNMENT MODAL SPECIFIC ===== */
.assign-info {
    background: var(--gray-50);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-bottom: var(--space-5);
}

.assign-info p {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--text-secondary);
}

.assign-info strong {
    color: var(--text-primary);
}

.users-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
}

.user-checkbox-item {
    display: flex;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s ease;
}

.user-checkbox-item:last-child {
    border-bottom: none;
}

.user-checkbox-item:hover {
    background: var(--gray-50);
}

.user-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: var(--space-3);
    cursor: pointer;
    accent-color: var(--success);
}

.user-checkbox-item label {
    flex: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.user-checkbox-item .user-avatar {
    width: 36px;
    height: 36px;
    background: var(--primary-blue);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

.user-checkbox-item .user-details {
    flex: 1;
}

.user-checkbox-item .user-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: var(--text-sm);
}

.user-checkbox-item .user-email {
    font-size: 11px;
    color: var(--text-tertiary);
}

.user-checkbox-item.assigned {
    background: rgba(16, 185, 129, 0.05);
}

.no-users-message {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.no-users-message i {
    font-size: 48px;
    color: var(--gray-400);
    margin-bottom: var(--space-3);
    display: block;
}

.select-all-container {
    padding: var(--space-3) var(--space-4);
    background: var(--gray-100);
    border-bottom: 2px solid var(--border-light);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.select-all-container label {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--text-primary);
    cursor: pointer;
}

.assignment-count {
    margin-left: auto;
    font-size: var(--text-sm);
    color: var(--text-secondary);
}

.assignment-count strong {
    color: var(--success);
}

/* ===== METADATA TABLE ===== */
.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}

.metadata-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
    margin: 0;
}

.metadata-table thead {
    background: var(--primary-blue);
    color: white;
}

.metadata-table th {
    padding: var(--space-3);
    text-align: left;
    font-weight: 600;
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.metadata-table tbody tr {
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s ease;
}

.metadata-table tbody tr:hover {
    background: var(--gray-50);
}

.metadata-table tbody tr:last-child {
    border-bottom: none;
}

.metadata-table td {
    padding: var(--space-3);
    color: var(--text-primary);
}

.field-name-col {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    color: var(--text-primary);
    font-size: var(--text-sm);
}

/* ===== TABLE BADGES ===== */
.type-badge {
    background: var(--info);
    color: white;
    padding: 4px var(--space-3);
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
}

.category-badge {
    padding: 4px var(--space-3);
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
}

.category-badge.sensor {
    background: var(--success);
    color: white;
}

.category-badge.info {
    background: var(--info);
    color: white;
}

.category-badge.slave {
    background: var(--warning);
    color: white;
}

/* ===== GRAPH TYPE ICONS ===== */
.graph-type-icons {
    display: flex;
    gap: var(--space-2);
}

.graph-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
}

.graph-icon.enabled {
    background: var(--success);
    color: white;
}

.graph-icon.enabled i {
    color: white;
}

.graph-icon.disabled {
    background: var(--gray-300);
    color: var(--gray-600);
}

.graph-icon.disabled i {
    color: var(--gray-600);
}

.empty-value {
    color: var(--text-muted);
    font-style: italic;
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 60px 40px;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 2px dashed var(--border-medium);
    grid-column: 1 / -1;
}

.empty-state i {
    font-size: 64px;
    color: var(--gray-400);
    margin-bottom: var(--space-5);
    display: block;
}

.empty-state h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-3);
}

.empty-state p {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-bottom: 0;
}

/* ===== LOADING STATES ===== */
.loading-spinner {
    text-align: center;
    padding: 40px;
}

.loading-spinner .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 4px;
    color: var(--primary-blue);
}

.loading-spinner p {
    margin-top: var(--space-3);
    color: var(--text-secondary);
    font-size: var(--text-sm);
}

.error-state {
    text-align: center;
    padding: 40px;
    color: var(--danger);
}

.error-state i {
    font-size: 48px;
    color: var(--danger);
    margin-bottom: var(--space-3);
    display: block;
}

/* ===== BUTTON STYLES ===== */
.btn-success-submit {
    background: var(--success);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    padding: 10px var(--space-5);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
}

.btn-success-submit:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-success-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-success-submit:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
    .device-container {
        padding: var(--space-4);
    }
    
    .device-grid {
        grid-template-columns: 1fr;
    }
    
    .device-actions-compact {
        grid-template-columns: 1fr;
    }
    
    .metadata-table {
        font-size: 11px;
    }
    
    .metadata-table th,
    .metadata-table td {
        padding: var(--space-2);
    }
    
    .welcome-card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .welcome-card h3 {
        font-size: var(--text-xl);
    }
}

@media (max-width: 480px) {
    .stats-badges {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="device-container">

    <!-- ==========================================
         WELCOME CARD
         ========================================== -->
    <div class="welcome-card">
        <div class="welcome-card-header">
            <div>
                <h3>
                    <i class="fas fa-microchip"></i>
                    My Devices
                </h3>
                <p>View and manage all IoT devices assigned to <strong>{{ department.name }}</strong></p>
            </div>
            <div class="stats-badges">
                <span class="stats-badge">
                    <i class="fas fa-microchip"></i>
                    {{ total_devices }} Total
                </span>
                <span class="stats-badge active">
                    <i class="fas fa-check-circle"></i>
                    {{ active_devices }} Active
                </span>
                <span class="stats-badge inactive">
                    <i class="fas fa-times-circle"></i>
                    {{ inactive_devices }} Inactive
                </span>
            </div>
        </div>
    </div>

    <!-- ==========================================
         DEVICES SECTION
         ========================================== -->
    {% if devices %}
    
    <div class="devices-section">
        
        <!-- Section Header -->
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-list"></i>
                All Devices in {{ department.name }}
            </div>
            <span class="section-badge">
                {{ total_devices }} Device{{ total_devices|pluralize }}
            </span>
        </div>

        <!-- Device Cards Grid -->
        <div class="device-grid">
            {% for device in devices %}
            <div class="device-card {% if not device.is_active %}inactive{% endif %}"
                 data-device-id="{{ device.id }}"
                 data-assigned-users="{{ device.assigned_user_ids|join:',' }}">
                
                <!-- Card Header -->
                <div class="device-card-header {% if not device.is_active %}inactive{% endif %}">
                    <h3 class="device-title {% if not device.is_active %}inactive{% endif %}">
                        <i class="fas fa-microchip"></i>
                        {{ device.display_name|truncatechars:25 }}
                    </h3>
                    <span class="device-id-label">
                        ID: {{ device.device_id }}
                    </span>
                </div>

                <!-- Card Body -->
                <div class="device-card-body">
                    
                    <!-- Device Info -->
                    <div class="device-info-compact">
                        
                        <!-- Status -->
                        <div class="device-info-row">
                            <span class="device-info-label">
                                <i class="fas fa-power-off"></i>
                                Status
                            </span>
                            <span class="device-badge {% if device.is_active %}active{% else %}inactive{% endif %}">
                                {% if device.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>

                        <!-- Device Type -->
                        <div class="device-info-row">
                            <span class="device-info-label">
                                <i class="fas fa-tag"></i>
                                Type
                            </span>
                            {% if device.device_type == 'industrial_sensor' %}
                                <span class="device-type-badge industrial_sensor">
                                    üè≠ Industrial
                                </span>
                            {% elif device.device_type == 'asset_tracking' %}
                                <span class="device-type-badge asset_tracking">
                                    üìç Asset
                                </span>
                            {% else %}
                                <span class="device-type-badge not-set">
                                    ‚ùì Not Set
                                </span>
                            {% endif %}
                        </div>

                        <!-- Measurement -->
                        <div class="device-info-row">
                            <span class="device-info-label">
                                <i class="fas fa-database"></i>
                                Measurement
                            </span>
                            <span style="font-size: 11px; font-family: monospace; color: var(--text-tertiary);">
                                {{ device.measurement_name|truncatechars:15 }}
                            </span>
                        </div>

                        <!-- Sensors -->
                        <div class="device-info-row">
                            <span class="device-info-label">
                                <i class="fas fa-chart-line"></i>
                                Sensors
                            </span>
                            <span class="device-badge sensor-count">
                                {{ device.total_sensors_only }}
                            </span>
                        </div>

                        <!-- Assigned Users -->
                        <div class="device-info-row">
                            <span class="device-info-label">
                                <i class="fas fa-users"></i>
                                Assigned
                            </span>
                            <span class="device-badge {% if device.assigned_users_count > 0 %}user-count{% else %}no-users{% endif %}"
                                  id="assigned-count-{{ device.id }}">
                                {{ device.assigned_users_count }} User{{ device.assigned_users_count|pluralize }}
                            </span>
                        </div>

                    </div>

                    <!-- Action Buttons (3 columns) -->
                    <div class="device-actions-compact">
                        <!-- Graphs/Map Button -->
                        <a href="{% url 'departmentadmin:device_visualization' device.id %}" 
                           class="device-btn-compact device-btn-graph-active"
                           {% if not device.is_active %}style="pointer-events: none; opacity: 0.5;"{% endif %}>
                            {% if device.device_type == 'asset_tracking' %}
                                <i class="fas fa-map-marked-alt"></i>
                                Map
                            {% else %}
                                <i class="fas fa-chart-line"></i>
                                Graphs
                            {% endif %}
                        </a>
                        
                        <!-- Sensors Button -->
                        <button type="button" 
                                class="device-btn-compact device-btn-sensors" 
                                onclick="openSensorsModal({{ device.id }})"
                                {% if not device.is_active %}disabled{% endif %}>
                            <i class="fas fa-sliders-h"></i>
                            Sensors
                        </button>
                        
                        <!-- Assign Button -->
                        <button type="button" 
                                class="device-btn-compact device-btn-assign" 
                                onclick="openAssignModal({{ device.id }}, '{{ device.display_name|escapejs }}')"
                                {% if not device.is_active %}disabled{% endif %}>
                            <i class="fas fa-user-plus"></i>
                            Assign
                        </button>
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>

    </div>

    {% else %}

    <!-- Empty State -->
    <div class="empty-state">
        <i class="fas fa-microchip"></i>
        <h3>No Devices in {{ department.name }}</h3>
        <p>No devices have been assigned to this department yet.</p>
    </div>

    {% endif %}

</div>

<!-- ==========================================
     SENSORS METADATA MODAL
     ========================================== -->
<div class="modal fade" id="sensorsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sliders-h"></i> 
                    <span id="modal-device-name">Device Sensors</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="sensors-content">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading sensor metadata...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==========================================
     ASSIGN USERS MODAL
     ========================================== -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="assignForm" method="POST">
                {% csrf_token %}
                
                <div class="modal-header assign-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> 
                        <span id="assign-modal-title">Assign Users to Device</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Info Box -->
                    <div class="assign-info">
                        <p>
                            <strong>Device:</strong> <span id="assign-device-name">‚Äî</span><br>
                            <strong>Workspace:</strong> {{ department.name }}
                        </p>
                    </div>
                    
                    <!-- Users List -->
                    <div id="assign-users-content">
                        <div class="loading-spinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading users...</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn-success-submit" id="saveAssignBtn">
                        <i class="fas fa-save"></i> Save Assignments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ==========================================
// CSRF TOKEN
// ==========================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// ==========================================
// SENSORS MODAL
// ==========================================
function openSensorsModal(deviceId) {
    document.getElementById('sensors-content').innerHTML = `
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading sensor metadata...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('sensorsModal'));
    modal.show();
    
    fetch(`/department/devices/${deviceId}/sensors/`, {
        method: 'GET',
        headers: {'X-CSRFToken': csrftoken}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modal-device-name').textContent = 
                `${data.device.display_name} - Sensor Metadata`;
            
            let html = '<div class="table-wrapper">';
            html += '<table class="metadata-table">';
            html += '<thead><tr>';
            html += '<th>Field Name</th><th>Display Name</th><th>Type</th><th>Category</th>';
            html += '<th>Unit</th><th>Upper</th><th>Lower</th><th>Center</th><th>Graphs</th>';
            html += '</tr></thead><tbody>';
            
            if (data.sensors.length === 0) {
                html += '<tr><td colspan="9" style="text-align: center; padding: 40px;">';
                html += '<i class="fas fa-exclamation-circle" style="font-size: 48px; color: var(--gray-400);"></i>';
                html += '<p>No sensors found</p></td></tr>';
            } else {
                data.sensors.forEach(sensor => {
                    html += '<tr>';
                    html += `<td class="field-name-col">${sensor.field_name}</td>`;
                    html += `<td>${sensor.display_name || '<span class="empty-value">‚Äî</span>'}</td>`;
                    html += `<td><span class="type-badge">${sensor.field_type}</span></td>`;
                    html += `<td><span class="category-badge ${sensor.category}">${sensor.category}</span></td>`;
                    html += `<td>${sensor.unit || '<span class="empty-value">‚Äî</span>'}</td>`;
                    html += `<td>${sensor.upper_limit ?? '<span class="empty-value">‚Äî</span>'}</td>`;
                    html += `<td>${sensor.lower_limit ?? '<span class="empty-value">‚Äî</span>'}</td>`;
                    html += `<td>${sensor.central_line ?? '<span class="empty-value">‚Äî</span>'}</td>`;
                    html += '<td><div class="graph-type-icons">';
                    html += `<span class="graph-icon ${sensor.show_time_series ? 'enabled' : 'disabled'}" title="Trend"><i class="fas fa-${sensor.show_time_series ? 'check' : 'times'}"></i></span>`;
                    html += `<span class="graph-icon ${sensor.show_latest_value ? 'enabled' : 'disabled'}" title="Gauge"><i class="fas fa-${sensor.show_latest_value ? 'check' : 'times'}"></i></span>`;
                    html += `<span class="graph-icon ${sensor.show_digital ? 'enabled' : 'disabled'}" title="Digital"><i class="fas fa-${sensor.show_digital ? 'check' : 'times'}"></i></span>`;
                    html += '</div></td></tr>';
                });
            }
            
            html += '</tbody></table></div>';
            document.getElementById('sensors-content').innerHTML = html;
        } else {
            document.getElementById('sensors-content').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${data.message}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('sensors-content').innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load sensor metadata</p>
            </div>
        `;
    });
}

// ==========================================
// ASSIGN USERS MODAL
// ==========================================
let currentAssignDeviceId = null;

function openAssignModal(deviceId, deviceName) {
    currentAssignDeviceId = deviceId;
    
    document.getElementById('assign-device-name').textContent = deviceName;
    document.getElementById('assign-modal-title').textContent = `Assign Users to "${deviceName}"`;
    document.getElementById('assignForm').action = `/department/devices/${deviceId}/assign/`;
    
    document.getElementById('assign-users-content').innerHTML = `
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading users...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('assignModal'));
    modal.show();
    
    // Fetch current assignments
    fetch(`/department/devices/${deviceId}/assign/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderUsersList(data.users, data.assigned_count);
        } else {
            document.getElementById('assign-users-content').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${data.message}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('assign-users-content').innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load users</p>
            </div>
        `;
    });
}

function renderUsersList(users, assignedCount) {
    if (users.length === 0) {
        document.getElementById('assign-users-content').innerHTML = `
            <div class="no-users-message">
                <i class="fas fa-users-slash"></i>
                <p>No users available in this department.</p>
                <p>Create users first to assign devices.</p>
            </div>
        `;
        document.getElementById('saveAssignBtn').disabled = true;
        return;
    }
    
    document.getElementById('saveAssignBtn').disabled = false;
    
    let html = '<div class="users-list">';
    
    // Select All row
    html += '<div class="select-all-container">';
    html += '<input type="checkbox" id="selectAllUsers" onclick="toggleSelectAll()">';
    html += '<label for="selectAllUsers">Select All Users</label>';
    html += `<span class="assignment-count"><strong id="selectedCount">${assignedCount}</strong> of ${users.length} selected</span>`;
    html += '</div>';
    
    // Users list
    users.forEach(user => {
        const initials = (user.first_name.charAt(0) + user.last_name.charAt(0)).toUpperCase() || user.username.charAt(0).toUpperCase();
        const isChecked = user.is_assigned ? 'checked' : '';
        const assignedClass = user.is_assigned ? 'assigned' : '';
        
        html += `<div class="user-checkbox-item ${assignedClass}">`;
        html += `<input type="checkbox" name="user_ids" value="${user.id}" id="user_${user.id}" ${isChecked} onchange="updateSelectedCount()">`;
        html += `<label for="user_${user.id}">`;
        html += `<span class="user-avatar">${initials}</span>`;
        html += '<span class="user-details">';
        html += `<span class="user-name">${user.full_name}</span>`;
        html += `<span class="user-email">${user.email}</span>`;
        html += '</span>';
        html += '</label>';
        html += '</div>';
    });
    
    html += '</div>';
    
    document.getElementById('assign-users-content').innerHTML = html;
    
    // Check if all are selected
    updateSelectAllState();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllUsers');
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        const item = cb.closest('.user-checkbox-item');
        if (selectAll.checked) {
            item.classList.add('assigned');
        } else {
            item.classList.remove('assigned');
        }
    });
    
    updateSelectedCount();
}

function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    const selectAll = document.getElementById('selectAllUsers');
    
    if (checkboxes.length === 0) return;
    
    const checkedCount = document.querySelectorAll('input[name="user_ids"]:checked').length;
    selectAll.checked = checkedCount === checkboxes.length;
    selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
}

function updateSelectedCount() {
    const checkedCount = document.querySelectorAll('input[name="user_ids"]:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (countEl) {
        countEl.textContent = checkedCount;
    }
    
    // Update item styling
    document.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        const item = cb.closest('.user-checkbox-item');
        if (cb.checked) {
            item.classList.add('assigned');
        } else {
            item.classList.remove('assigned');
        }
    });
    
    updateSelectAllState();
}

// ==========================================
// FORM SUBMISSION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    
    // Assign form submission
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('saveAssignBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const formData = new FormData(assignForm);
            
            fetch(assignForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the card's assigned count
                    const countEl = document.getElementById(`assigned-count-${currentAssignDeviceId}`);
                    if (countEl) {
                        const count = data.total_assigned;
                        countEl.textContent = `${count} User${count !== 1 ? 's' : ''}`;
                        countEl.className = `device-badge ${count > 0 ? 'user-count' : 'no-users'}`;
                    }
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                    
                    // Show success message
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message || 'Error saving assignments', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to save assignments', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        });
    }
});

// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
function showToast(message, type = 'info') {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(t => t.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Add styles if not exists
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }
            .toast-success { background: #10b981; }
            .toast-error { background: #ef4444; }
            .toast-info { background: #3b82f6; }
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}