{% extends 'userdashboard/base.html' %}
{% load static %}

{% block title %}{{ device.display_name }} - Graphs{% endblock %}

{% block extra_css %}
<style>
    .graphs-container { padding: 0; }
    
    .page-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .page-header h1 { font-size: 1.5rem; font-weight: 600; margin: 0; }
    .page-header .device-info { font-size: 0.875rem; opacity: 0.85; margin-top: 0.25rem; }
    
    .controls-bar {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .time-range-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    
    .time-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        color: #64748b;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .time-btn:hover { border-color: #3b82f6; color: #3b82f6; }
    .time-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }
    
    .refresh-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .refresh-btn:hover { background: #059669; }
    .refresh-btn:disabled { background: #94a3b8; cursor: not-allowed; }
    
    .refresh-btn .spinner {
        display: none;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .refresh-btn.loading .spinner { display: inline-block; }
    .refresh-btn.loading .refresh-icon { display: none; }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 2rem 0 1rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .section-header h2 { font-size: 1.125rem; font-weight: 600; color: #1e293b; margin: 0; }
    
    .section-header .badge {
        background: #e2e8f0;
        color: #64748b;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .section-header.trend .badge { background: #dbeafe; color: #1d4ed8; }
    .section-header.gauge .badge { background: #dcfce7; color: #15803d; }
    .section-header.digital .badge { background: #fef3c7; color: #b45309; }
    
    /* FIXED: 2 charts per row maximum */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 1024px) { 
        .charts-grid { grid-template-columns: 1fr; } 
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        overflow: hidden;
        transition: box-shadow 0.2s;
    }
    
    .chart-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    
    .chart-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chart-card-title { font-size: 0.938rem; font-weight: 600; color: #1e293b; margin: 0; }
    .chart-card-subtitle { font-size: 0.75rem; color: #64748b; margin-top: 0.125rem; }
    
    .latest-value-badge {
        background: #f1f5f9;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #334155;
    }
    
    .chart-card-body { padding: 1rem 1.25rem 1.25rem; position: relative; }
    .chart-wrapper { position: relative; height: 280px; }
    
    .chart-limits-legend {
        display: flex;
        gap: 1rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f1f5f9;
        font-size: 0.75rem;
    }
    
    .limit-item { display: flex; align-items: center; gap: 0.375rem; color: #64748b; }
    .limit-line { width: 20px; height: 2px; }
    .limit-line.upper { background: #ef4444; }
    .limit-line.lower { background: #f97316; }
    .limit-line.center { background: #22c55e; }
    
    /* FIXED: 4 gauges per row maximum */
    .gauges-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 1024px) { 
        .gauges-grid { grid-template-columns: repeat(3, 1fr); } 
    }
    
    @media (max-width: 768px) { 
        .gauges-grid { grid-template-columns: repeat(2, 1fr); } 
    }
    
    .gauge-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        padding: 1.25rem;
        text-align: center;
        transition: all 0.2s;
    }
    
    .gauge-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .gauge-card-title { font-size: 0.813rem; font-weight: 500; color: #64748b; margin-bottom: 0.75rem; }
    .gauge-value { font-size: 2rem; font-weight: 700; color: #1e293b; line-height: 1.2; }
    .gauge-value .unit { font-size: 1rem; font-weight: 400; color: #64748b; margin-left: 0.25rem; }
    
    .gauge-status {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
    }
    
    .gauge-status.normal { background: #dcfce7; color: #15803d; }
    .gauge-status.warning { background: #fef3c7; color: #b45309; }
    .gauge-status.danger { background: #fee2e2; color: #dc2626; }
    
    /* FIXED: 6 digital cards per row maximum */
    .digital-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 1024px) { 
        .digital-grid { grid-template-columns: repeat(4, 1fr); } 
    }
    
    @media (max-width: 768px) { 
        .digital-grid { grid-template-columns: repeat(3, 1fr); } 
    }
    
    @media (max-width: 480px) { 
        .digital-grid { grid-template-columns: repeat(2, 1fr); } 
    }
    
    .digital-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        padding: 1.25rem;
        text-align: center;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .digital-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .digital-card.on { border-color: #22c55e; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
    .digital-card.off { border-color: #e2e8f0; background: #f8fafc; }
    .digital-card-title { font-size: 0.813rem; font-weight: 500; color: #64748b; margin-bottom: 0.75rem; }
    .digital-indicator { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    
    .digital-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }
    
    .digital-card.on .digital-dot { background: #22c55e; box-shadow: 0 0 8px #22c55e; animation: pulse-green 2s infinite; }
    .digital-card.off .digital-dot { background: #94a3b8; }
    
    @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 8px #22c55e; } 50% { box-shadow: 0 0 16px #22c55e; } }
    
    .digital-label { font-size: 1.25rem; font-weight: 700; }
    .digital-card.on .digital-label { color: #15803d; }
    .digital-card.off .digital-label { color: #64748b; }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e2e8f0;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .error-message {
        background: #fee2e2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .empty-state { text-align: center; padding: 4rem 2rem; color: #64748b; }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state h3 { font-size: 1.125rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem; }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        text-decoration: none;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        transition: color 0.2s;
    }
    
    .back-link:hover { color: #3b82f6; }
    .back-link svg { width: 16px; height: 16px; }
</style>
{% endblock %}

{% block content %}
<div class="graphs-container">
    <a href="{% url 'userdashboard:user_devices' %}" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Devices
    </a>
    
    <div class="page-header">
        <h1>{{ device.display_name }}</h1>
        <div class="device-info">Device ID: {{ device.device_id }} | Measurement: {{ device.measurement_name }}</div>
    </div>
    
    <div class="controls-bar">
        <div class="time-range-buttons">
            <button class="time-btn" data-range="now() - 15m">15m</button>
            <button class="time-btn" data-range="now() - 30m">30m</button>
            <button class="time-btn active" data-range="now() - 1h">1h</button>
            <button class="time-btn" data-range="now() - 2h">2h</button>
            <button class="time-btn" data-range="now() - 6h">6h</button>
            <button class="time-btn" data-range="now() - 12h">12h</button>
            <button class="time-btn" data-range="now() - 24h">24h</button>
            <button class="time-btn" data-range="now() - 7d">7d</button>
        </div>
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <span class="spinner"></span>
            Refresh
        </button>
    </div>
    
    <div id="errorContainer" style="display: none;"></div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div id="chartsContent"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
(function() {
    'use strict';
    
    console.log('Graph script starting...');
    
    const DEVICE_ID = {{ device.id }};
    const API_URL = "{% url 'userdashboard:user_device_graphs_data' device.id %}";
    
    let currentTimeRange = 'now() - 1h';
    let chartInstances = {};
    let isLoading = false;
    
    const chartsContent = document.getElementById('chartsContent');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorContainer = document.getElementById('errorContainer');
    const refreshBtn = document.getElementById('refreshBtn');
    const timeBtns = document.querySelectorAll('.time-btn');
    
    init();
    
    function init() {
        console.log('Initializing...');
        
        timeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (isLoading) return;
                timeBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeRange = this.dataset.range;
                fetchData();
            });
        });
        
        refreshBtn.addEventListener('click', function() {
            if (!isLoading) fetchData();
        });
        
        fetchData();
    }
    
    async function fetchData() {
        if (isLoading) return;
        
        isLoading = true;
        loadingOverlay.style.display = 'flex';
        errorContainer.style.display = 'none';
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
        
        console.log('Fetching data from:', API_URL);
        
        try {
            const url = `${API_URL}?time_range=${encodeURIComponent(currentTimeRange)}`;
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('Data received:', result);
            
            if (!result.success) {
                throw new Error(result.message || 'Failed to fetch data');
            }
            
            renderCharts(result.data);
            
        } catch (error) {
            console.error('Fetch error:', error);
            errorContainer.innerHTML = `<div class="error-message"><span>Error: ${error.message}</span></div>`;
            errorContainer.style.display = 'block';
        } finally {
            isLoading = false;
            loadingOverlay.style.display = 'none';
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
        }
    }
    
    function renderCharts(data) {
        console.log('Rendering charts...');
        
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};
        
        const { timestamps, sensors } = data;
        
        console.log('Timestamps:', timestamps?.length);
        console.log('Sensors:', sensors?.length);
        
        if (!sensors || sensors.length === 0) {
            chartsContent.innerHTML = '<div class="empty-state"><h3>No Sensors Found</h3><p>This device has no active sensors</p></div>';
            return;
        }
        
        const trendSensors = [];
        const gaugeSensors = [];
        const digitalSensors = [];
        
        sensors.forEach(sensor => {
            if (sensor.category === 'info') {
                if (!sensor.values.some(v => v !== null)) return;
            }
            
            if (sensor.metadata) {
                const types = sensor.metadata.data_types || [];
                if (types.includes('trend') || sensor.metadata.show_time_series) trendSensors.push(sensor);
                if (types.includes('latest_value') || sensor.metadata.show_latest_value) gaugeSensors.push(sensor);
                if (types.includes('digital') || sensor.metadata.show_digital) digitalSensors.push(sensor);
            } else {
                trendSensors.push(sensor);
            }
        });
        
        console.log('Trend:', trendSensors.length, 'Gauge:', gaugeSensors.length, 'Digital:', digitalSensors.length);
        
        let html = '';
        
        // TREND SECTION
        if (trendSensors.length > 0) {
            html += `<div class="section-header trend"><h2>ðŸ“ˆ Time Series</h2><span class="badge">${trendSensors.length}</span></div><div class="charts-grid">`;
            
            trendSensors.forEach(sensor => {
                const chartId = `chart-${sensor.id}`;
                html += `
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div>
                                <h3 class="chart-card-title">${sensor.display_name}</h3>
                                <div class="chart-card-subtitle">${sensor.field_name}</div>
                            </div>
                            <span class="latest-value-badge">${formatVal(sensor.latest_value)} ${sensor.unit || ''}</span>
                        </div>
                        <div class="chart-card-body">
                            <div class="chart-wrapper"><canvas id="${chartId}"></canvas></div>
                            ${renderLimits(sensor.metadata)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // GAUGE SECTION
        if (gaugeSensors.length > 0) {
            html += `<div class="section-header gauge"><h2>ðŸŽ¯ Latest Values</h2><span class="badge">${gaugeSensors.length}</span></div><div class="gauges-grid">`;
            
            gaugeSensors.forEach(sensor => {
                const status = getStatus(sensor.latest_value, sensor.metadata);
                html += `
                    <div class="gauge-card">
                        <div class="gauge-card-title">${sensor.display_name}</div>
                        <div class="gauge-value">${formatVal(sensor.latest_value)} <span class="unit">${sensor.unit || ''}</span></div>
                        <span class="gauge-status ${status.cls}">${status.label}</span>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // DIGITAL SECTION
        if (digitalSensors.length > 0) {
            html += `<div class="section-header digital"><h2>âš¡ Digital I/O</h2><span class="badge">${digitalSensors.length}</span></div><div class="digital-grid">`;
            
            digitalSensors.forEach(sensor => {
                const isOn = sensor.latest_value === 1 || sensor.latest_value === true;
                html += `
                    <div class="digital-card ${isOn ? 'on' : 'off'}">
                        <div class="digital-card-title">${sensor.display_name}</div>
                        <div class="digital-indicator">
                            <span class="digital-dot"></span>
                            <span class="digital-label">${isOn ? 'ON' : 'OFF'}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        if (!html) {
            html = '<div class="empty-state"><h3>No Data</h3><p>No displayable data for this time range</p></div>';
        }
        
        chartsContent.innerHTML = html;
        console.log('HTML set, creating charts...');
        
        setTimeout(() => {
            trendSensors.forEach(sensor => {
                createChart(`chart-${sensor.id}`, sensor, timestamps);
            });
            console.log('Charts created');
        }, 100);
    }
    
    function formatVal(v) {
        if (v === null || v === undefined) return 'â€”';
        if (typeof v === 'number') return Number.isInteger(v) ? v : v.toFixed(2);
        return String(v);
    }
    
    function renderLimits(meta) {
        if (!meta) return '';
        let items = [];
        if (meta.upper_limit != null) items.push(`<div class="limit-item"><span class="limit-line upper"></span> Upper: ${meta.upper_limit}</div>`);
        if (meta.center_line != null) items.push(`<div class="limit-item"><span class="limit-line center"></span> Center: ${meta.center_line}</div>`);
        if (meta.lower_limit != null) items.push(`<div class="limit-item"><span class="limit-line lower"></span> Lower: ${meta.lower_limit}</div>`);
        return items.length ? `<div class="chart-limits-legend">${items.join('')}</div>` : '';
    }
    
    function getStatus(val, meta) {
        if (val === null || val === undefined) return { cls: '', label: 'No Data' };
        if (!meta) return { cls: 'normal', label: 'OK' };
        if (meta.upper_limit != null && val > meta.upper_limit) return { cls: 'danger', label: 'HIGH' };
        if (meta.lower_limit != null && val < meta.lower_limit) return { cls: 'danger', label: 'LOW' };
        return { cls: 'normal', label: 'Normal' };
    }
    
    function createChart(canvasId, sensor, timestamps) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error('Canvas not found:', canvasId);
            return;
        }
        
        const ctx = canvas.getContext('2d');
        const annotations = {};
        
        if (sensor.metadata) {
            if (sensor.metadata.upper_limit != null) {
                annotations.upper = { type: 'line', yMin: sensor.metadata.upper_limit, yMax: sensor.metadata.upper_limit, borderColor: '#ef4444', borderWidth: 2, borderDash: [5, 5] };
            }
            if (sensor.metadata.lower_limit != null) {
                annotations.lower = { type: 'line', yMin: sensor.metadata.lower_limit, yMax: sensor.metadata.lower_limit, borderColor: '#f97316', borderWidth: 2, borderDash: [5, 5] };
            }
            if (sensor.metadata.center_line != null) {
                annotations.center = { type: 'line', yMin: sensor.metadata.center_line, yMax: sensor.metadata.center_line, borderColor: '#22c55e', borderWidth: 2, borderDash: [8, 4] };
            }
        }
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: sensor.display_name,
                    data: sensor.values,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    spanGaps: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        callbacks: {
                            label: ctx => `${sensor.display_name}: ${formatVal(ctx.parsed.y)} ${sensor.unit || ''}`
                        }
                    },
                    annotation: { annotations }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 8,
                            maxRotation: 0,
                            font: { size: 10 },
                            callback: function(val) {
                                const label = this.getLabelForValue(val);
                                return label ? label.split(' ')[1] || label : '';
                            }
                        }
                    },
                    y: {
                        display: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { size: 10 } }
                    }
                }
            }
        });
        
        chartInstances[canvasId] = chart;
        console.log('Chart created:', canvasId);
    }
    
})();
</script>
{% endblock %}