{% extends 'companyadmin/base.html' %}
{% load static %}

{% block title %}Dashboard - Company Admin{% endblock %}
{% block page_heading %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Use Barlow font consistently */
* {
    font-family: 'Barlow', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body {
    background: #f5f7fa;
}

/* Dashboard Container */
.dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
}

/* ========== WELCOME HERO SECTION ========== */
.welcome-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    color: white;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.welcome-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}

.welcome-hero-content {
    position: relative;
    z-index: 1;
}

.welcome-hero h1 {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.welcome-hero p {
    font-size: 16px;
    margin: 0;
    opacity: 0.95;
}

.welcome-hero-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ========== STATS GRID (6 Cards) ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s;
    border: 2px solid transparent;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    border-color: #667eea;
}

.stat-card-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon i {
    font-size: 24px;
    color: white;
}

.stat-details {
    flex: 1;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 4px 0;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #333B4A;
    margin: 0;
    line-height: 1;
}

.stat-footer {
    font-size: 12px;
    color: #6c757d;
    margin-top: 8px;
}

.stat-footer i {
    margin-right: 4px;
}

/* Status Badge in Card */
.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
}

.status-badge.online {
    background: #d4edda;
    color: #155724;
}

.status-badge.offline {
    background: #f8d7da;
    color: #721c24;
}

/* ========== QUICK ACTIONS SECTION ========== */
.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-header h2 {
    font-size: 22px;
    font-weight: 700;
    color: #333B4A;
    margin: 0;
}

.section-header i {
    color: #667eea;
    font-size: 24px;
}

.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.action-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 24px;
    text-decoration: none;
    color: #333B4A;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 20px;
}

.action-card:hover {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    text-decoration: none;
}

.action-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s;
}

.action-card:hover .action-icon {
    background: rgba(255, 255, 255, 0.2);
}

.action-icon i {
    font-size: 24px;
    color: #667eea;
    transition: all 0.3s;
}

.action-card:hover .action-icon i {
    color: white;
}

.action-content h3 {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 4px 0;
}

.action-content p {
    font-size: 13px;
    margin: 0;
    opacity: 0.7;
}

/* ========== RECENT ACTIVITY TABLE ========== */
.activity-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.activity-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    padding: 20px 24px;
    border-bottom: 2px solid #e9ecef;
}

.activity-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #333B4A;
}

/* Activity Table */
.activity-table {
    width: 100%;
    border-collapse: collapse;
}

.activity-table thead {
    background: #667eea;
    color: white;
}

.activity-table th {
    padding: 14px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.activity-table tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background 0.2s;
}

.activity-table tbody tr:hover {
    background: #f8f9fa;
}

.activity-table tbody tr:last-child {
    border-bottom: none;
}

.activity-table td {
    padding: 16px 20px;
    font-size: 14px;
    color: #4C4C5C;
}

.activity-icon-cell {
    width: 50px;
}

.activity-icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.activity-title {
    font-weight: 600;
    color: #333B4A;
    margin: 0 0 4px 0;
}

.activity-description {
    font-size: 13px;
    color: #6c757d;
    margin: 0;
}

.activity-time {
    font-size: 12px;
    color: #999;
    white-space: nowrap;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 48px;
    color: #e9ecef;
    margin-bottom: 12px;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 16px;
    }
    
    .welcome-hero {
        padding: 24px;
    }
    
    .welcome-hero h1 {
        font-size: 24px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-value {
        font-size: 28px;
    }
    
    .activity-table {
        font-size: 12px;
    }
    
    .activity-table th,
    .activity-table td {
        padding: 10px 12px;
    }
}

/* ========== ANIMATIONS ========== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.welcome-hero,
.stat-card,
.action-card,
.activity-card {
    animation: fadeInUp 0.5s ease-out;
}

.stat-card:nth-child(1) { animation-delay: 0.05s; }
.stat-card:nth-child(2) { animation-delay: 0.1s; }
.stat-card:nth-child(3) { animation-delay: 0.15s; }
.stat-card:nth-child(4) { animation-delay: 0.2s; }
.stat-card:nth-child(5) { animation-delay: 0.25s; }
.stat-card:nth-child(6) { animation-delay: 0.3s; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- ========== WELCOME HERO ========== -->
    <div class="welcome-hero">
        <div class="welcome-hero-content">
            <h1>
                <div class="welcome-hero-icon">
                    <i class="fas fa-user"></i>
                </div>
                Welcome back, {{ request.user.get_full_name_or_username|default:request.user.username }}!
            </h1>
            <p>
                <i class="fas fa-clock me-2"></i>
                Last login: {{ last_login|date:"M d, Y h:i A"|default:"First time login" }}
            </p>
        </div>
    </div>

    <!-- ========== STATS GRID (6 CARDS) ========== -->
    <div class="stats-grid">
        
        <!-- Total Users -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Total Users</p>
                    <h3 class="stat-value">{{ total_users }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-user-check" style="color: #28a745;"></i>
                Active users
            </div>
        </div>

        <!-- Department Admins -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Dept Admins</p>
                    <h3 class="stat-value">{{ total_dept_admins }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-shield-alt" style="color: #17a2b8;"></i>
                Administrators
            </div>
        </div>

        <!-- Departments -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Departments</p>
                    <h3 class="stat-value">{{ total_departments }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-sitemap" style="color: #fd7e14;"></i>
                Active depts
            </div>
        </div>

        <!-- Operators -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Operators</p>
                    <h3 class="stat-value">{{ total_read_only_users }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-user" style="color: #6c757d;"></i>
                Read-only users
            </div>
        </div>

        <!-- InfluxDB Status -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">InfluxDB</p>
                    <h3 class="stat-value" style="font-size: 20px;">
                        {% if influx_status == 'online' %}
                        <span class="status-badge online">
                            <i class="fas fa-check-circle me-1"></i>Online
                        </span>
                        {% else %}
                        <span class="status-badge offline">
                            <i class="fas fa-times-circle me-1"></i>Offline
                        </span>
                        {% endif %}
                    </h3>
                </div>
            </div>
            <div class="stat-footer">
                {% if influx_config %}
                    <i class="fas fa-server"></i> {{ influx_config.db_name }}
                {% else %}
                    <i class="fas fa-exclamation-triangle"></i> Not configured
                {% endif %}
            </div>
        </div>

        <!-- IoT Devices -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">IoT Devices</p>
                    <h3 class="stat-value">{{ total_devices }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                {% if total_sensors > 0 %}
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    {{ configured_sensors }}/{{ total_sensors }} sensors configured
                {% else %}
                    <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                    No sensors yet
                {% endif %}
            </div>
        </div>

    </div>

    <!-- ========== QUICK ACTIONS ========== -->
    <div class="section-header">
        <i class="fas fa-bolt"></i>
        <h2>Quick Actions</h2>
    </div>

    <div class="quick-actions-grid">
        
        <!-- Manage Departments -->
        <a href="{% url 'companyadmin:departments' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="action-content">
                <h3>Manage Departments</h3>
                <p>Create, edit, and organize departments</p>
            </div>
        </a>

        <!-- Department Admins -->
        <a href="{% url 'companyadmin:users' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="action-content">
                <h3>Department Admins</h3>
                <p>Add and assign administrators</p>
            </div>
        </a>

        <!-- IoT Devices -->
        <a href="{% url 'companyadmin:device_list' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="action-content">
                <h3>IoT Devices</h3>
                <p>Manage connected devices and sensors</p>
            </div>
        </a>

        <!-- InfluxDB Configuration -->
        <a href="{% url 'companyadmin:influx_config' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-database"></i>
            </div>
            <div class="action-content">
                <h3>InfluxDB Config</h3>
                <p>Configure time-series database</p>
            </div>
        </a>

        <!-- Device Setup Wizard -->
        <a href="{% url 'companyadmin:device_setup_wizard' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-magic"></i>
            </div>
            <div class="action-content">
                <h3>Setup Wizard</h3>
                <p>Discover and configure new devices</p>
            </div>
        </a>

        <!-- Sensor Configuration -->
        <a href="{% url 'companyadmin:device_list' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div class="action-content">
                <h3>Sensor Metadata</h3>
                <p>Configure sensor properties and limits</p>
            </div>
        </a>

    </div>

    <!-- ========== RECENT ACTIVITY (FULL WIDTH TABLE) ========== -->
    <div class="section-header">
        <i class="fas fa-history"></i>
        <h2>Recent Activity</h2>
    </div>

    <div class="activity-card">
        {% if recent_activities %}
        <table class="activity-table">
            <thead>
                <tr>
                    <th style="width: 50px;"></th>
                    <th>Activity</th>
                    <th>Details</th>
                    <th style="width: 150px;">Time</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in recent_activities %}
                <tr>
                    <td class="activity-icon-cell">
                        <div class="activity-icon-wrapper" style="background: {{ activity.color }};">
                            <i class="fas {{ activity.icon }}" style="color: {{ activity.icon_color }};"></i>
                        </div>
                    </td>
                    <td>
                        <p class="activity-title">{{ activity.title }}</p>
                    </td>
                    <td>
                        <p class="activity-description">{{ activity.description }}</p>
                    </td>
                    <td>
                        <span class="activity-time">{{ activity.time|timesince }} ago</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-history"></i>
            <p style="margin: 0;">No recent activity in the last 7 days</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}