{% extends 'companyadmin/base.html' %}
{% load static %}

{% block title %}Dashboard - Company Admin{% endblock %}
{% block page_heading %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   DASHBOARD - PRIMARY BLUE THEME
   Matches Workspace design system
   ======================================== */

/* ===== GLOBAL ===== */
* {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body {
    background: var(--gray-50);
}

/* ===== CONTAINER ===== */
.dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: var(--space-6);
}

/* ===== WELCOME HERO - PRIMARY BLUE ===== */
.welcome-hero {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
    border-radius: var(--radius-lg);
    padding: 40px;
    margin-bottom: var(--space-6);
    color: white;
    box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
    position: relative;
    overflow: hidden;
}

.welcome-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 50%;
    animation: pulse 15s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.08; }
    50% { transform: scale(1.1); opacity: 0.12; }
}

.welcome-hero-content {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
}

.welcome-text h1 {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.welcome-text p {
    font-size: 15px;
    margin: 0;
    opacity: 0.95;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.welcome-hero-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.welcome-hero-icon i {
    font-size: 24px;
}

.welcome-badge {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 600;
    font-size: 14px;
}

.welcome-badge i {
    font-size: 18px;
}

/* ===== STATS GRID ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: var(--space-5);
    margin-bottom: var(--space-6);
}

/* ===== STAT CARD ===== */
.stat-card {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-blue), var(--primary-blue-dark));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-blue);
}

.stat-card:hover::before {
    transform: scaleX(1);
}

.stat-card-header {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    margin-bottom: var(--space-3);
}

.stat-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
}

.stat-icon i {
    font-size: 28px;
    color: white;
    z-index: 1;
    position: relative;
}

.stat-icon.blue {
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
}

.stat-icon.teal {
    background: linear-gradient(135deg, #14b8a6, #0d9488);
}

.stat-icon.orange {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.stat-icon.purple {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.stat-icon.green {
    background: linear-gradient(135deg, #10b981, #059669);
}

.stat-icon.indigo {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
}

.stat-details {
    flex: 1;
    min-width: 0;
}

.stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 var(--space-2) 0;
}

.stat-value {
    font-size: 36px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    line-height: 1;
}

.stat-footer {
    font-size: 13px;
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-3);
}

.stat-footer i {
    color: var(--primary-blue);
}

/* ===== STATUS BADGES ===== */
.status-badge {
    padding: 6px var(--space-3);
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
}

.status-badge.online {
    background: var(--success-light);
    color: var(--success);
}

.status-badge.offline {
    background: var(--danger-light);
    color: var(--danger);
}

/* ===== ✨ NEW: INFLUXDB CONFIGS GRID ===== */
.influx-configs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.influx-config-card {
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    transition: all 0.3s ease;
}

.influx-config-card:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.influx-config-card.online {
    border-left: 4px solid var(--success);
}

.influx-config-card.offline {
    border-left: 4px solid var(--danger);
}

.influx-config-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: var(--space-4);
}

.influx-config-title {
    flex: 1;
}

.influx-config-title h3 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-1) 0;
}

.influx-config-title p {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
}

.influx-config-body {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.influx-config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--border-light);
}

.influx-config-row:last-child {
    border-bottom: none;
}

.influx-config-label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
}

.influx-config-value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
}

.influx-config-footer {
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--border-light);
    font-size: 12px;
    color: var(--text-tertiary);
}

/* ===== SECTION HEADER ===== */
.section-header {
    background: var(--bg-primary);
    border-left: 4px solid var(--primary-blue);
    border: 1px solid var(--border-light);
    border-left-width: 4px;
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-5);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    box-shadow: var(--shadow-sm);
}

.section-header h2 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.section-header i {
    color: var(--primary-blue);
    font-size: 22px;
}

/* ===== QUICK ACTIONS GRID ===== */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

/* ===== ACTION CARD ===== */
.action-card {
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    position: relative;
    overflow: hidden;
}

.action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.action-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    text-decoration: none;
}

.action-card:hover::before {
    opacity: 1;
}

.action-card:hover .action-content h3,
.action-card:hover .action-content p {
    color: white;
    position: relative;
    z-index: 1;
}

.action-icon {
    width: 64px;
    height: 64px;
    background: var(--gray-100);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}

.action-card:hover .action-icon {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
}

.action-icon i {
    font-size: 28px;
    color: var(--primary-blue);
    transition: all 0.3s ease;
}

.action-card:hover .action-icon i {
    color: white;
    transform: scale(1.1);
}

.action-content h3 {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 var(--space-1) 0;
    transition: color 0.3s ease;
}

.action-content p {
    font-size: 13px;
    margin: 0;
    color: var(--text-secondary);
    transition: color 0.3s ease;
}

/* ===== ACTIVITY CARD ===== */
.activity-card {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    overflow: hidden;
}

/* ===== ACTIVITY TABLE ===== */
.activity-table {
    width: 100%;
    border-collapse: collapse;
}

.activity-table thead {
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
    color: white;
}

.activity-table th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.activity-table tbody tr {
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s ease;
}

.activity-table tbody tr:hover {
    background: var(--gray-50);
}

.activity-table tbody tr:last-child {
    border-bottom: none;
}

.activity-table td {
    padding: 18px 20px;
    font-size: 14px;
    color: var(--text-primary);
}

.activity-icon-cell {
    width: 60px;
}

.activity-icon-wrapper {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.activity-icon-wrapper i {
    font-size: 18px;
}

.activity-title {
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 4px 0;
}

.activity-description {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
}

.activity-time {
    font-size: 12px;
    color: var(--text-tertiary);
    white-space: nowrap;
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--text-tertiary);
}

.empty-state i {
    font-size: 64px;
    color: var(--gray-300);
    margin-bottom: var(--space-4);
    display: block;
}

.empty-state p {
    margin: 0;
    font-size: 15px;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.welcome-hero,
.stat-card,
.action-card,
.activity-card,
.section-header,
.influx-config-card {
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.stat-card:nth-child(1) { animation-delay: 0.05s; }
.stat-card:nth-child(2) { animation-delay: 0.1s; }
.stat-card:nth-child(3) { animation-delay: 0.15s; }
.stat-card:nth-child(4) { animation-delay: 0.2s; }
.stat-card:nth-child(5) { animation-delay: 0.25s; }
.stat-card:nth-child(6) { animation-delay: 0.3s; }

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    
    .quick-actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .influx-configs-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: var(--space-4);
    }
    
    .welcome-hero {
        padding: var(--space-5);
    }
    
    .welcome-text h1 {
        font-size: 24px;
    }
    
    .welcome-hero-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-value {
        font-size: 32px;
    }
    
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .influx-configs-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- ========== WELCOME HERO ========== -->
    <div class="welcome-hero">
        <div class="welcome-hero-content">
            <div class="welcome-text">
                <h1>
                    <div class="welcome-hero-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    Welcome back, {{ request.user.get_full_name_or_username|default:request.user.username }}!
                </h1>
                <p>
                    <i class="fas fa-clock"></i>
                    Last login: {{ last_login|date:"M d, Y h:i A"|default:"First time login" }}
                </p>
            </div>
            <div class="welcome-badge">
                <i class="fas fa-shield-alt"></i>
                Company Admin
            </div>
        </div>
    </div>

    <!-- ========== STATS GRID ========== -->
    <div class="stats-grid">
        
        <!-- Total Users -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon blue">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Total Users</p>
                    <h3 class="stat-value">{{ total_users }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-user-check"></i>
                Active system users
            </div>
        </div>

        <!-- Workspace Admins -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon teal">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Workspace Admins</p>
                    <h3 class="stat-value">{{ total_dept_admins }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-shield-alt"></i>
                Workspace administrators
            </div>
        </div>

        <!-- Workspaces -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon orange">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Workspaces</p>
                    <h3 class="stat-value">{{ total_departments }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-sitemap"></i>
                Active workspaces
            </div>
        </div>

        <!-- Operators -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon purple">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">Operators</p>
                    <h3 class="stat-value">{{ total_read_only_users }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                <i class="fas fa-user"></i>
                Read-only users
            </div>
        </div>

        <!-- ✨ NEW: InfluxDB Instances Summary -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon green">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">InfluxDB Instances</p>
                    <h3 class="stat-value">{{ total_influx_configs }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                {% if total_influx_online > 0 %}
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    {{ total_influx_online }} online
                {% endif %}
                {% if total_influx_offline > 0 %}
                    <i class="fas fa-times-circle" style="color: var(--danger);"></i>
                    {{ total_influx_offline }} offline
                {% endif %}
                {% if total_influx_configs == 0 %}
                    <i class="fas fa-exclamation-triangle"></i>
                    Not configured
                {% endif %}
            </div>
        </div>

        <!-- IoT Devices -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon indigo">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-details">
                    <p class="stat-label">IoT Devices</p>
                    <h3 class="stat-value">{{ total_devices }}</h3>
                </div>
            </div>
            <div class="stat-footer">
                {% if total_sensors > 0 %}
                    <i class="fas fa-check-circle"></i>
                    {{ configured_sensors }}/{{ total_sensors }} sensors configured
                {% else %}
                    <i class="fas fa-exclamation-triangle"></i>
                    No sensors yet
                {% endif %}
            </div>
        </div>

    </div>

    <!-- ========== ✨ NEW: INFLUXDB CONFIGURATIONS SECTION ========== -->
    {% if influx_configs %}
    <div class="section-header">
        <i class="fas fa-database"></i>
        <h2>InfluxDB Configurations</h2>
    </div>

    <div class="influx-configs-grid">
        {% for config_data in influx_configs %}
        <div class="influx-config-card {{ config_data.status }}">
            <div class="influx-config-header">
                <div class="influx-config-title">
                    <h3>{{ config_data.config.config_name }}</h3>
                    <p>{{ config_data.config.db_name }}</p>
                </div>
                <span class="status-badge {{ config_data.status }}">
                    {% if config_data.status == 'online' %}
                        <i class="fas fa-check-circle"></i>Online
                    {% else %}
                        <i class="fas fa-times-circle"></i>Offline
                    {% endif %}
                </span>
            </div>
            
            <div class="influx-config-body">
                <div class="influx-config-row">
                    <span class="influx-config-label">
                        <i class="fas fa-server"></i> API URL
                    </span>
                    <span class="influx-config-value">{{ config_data.config.base_api|truncatechars:30 }}</span>
                </div>
                
                <div class="influx-config-row">
                    <span class="influx-config-label">
                        <i class="fas fa-microchip"></i> Devices
                    </span>
                    <span class="influx-config-value">{{ config_data.device_count }}</span>
                </div>
                
                <div class="influx-config-row">
                    <span class="influx-config-label">
                        <i class="fas fa-sensor"></i> Sensors
                    </span>
                    <span class="influx-config-value">{{ config_data.sensor_count }}</span>
                </div>
            </div>
            
            <div class="influx-config-footer">
                {% if config_data.status == 'offline' and config_data.error_message %}
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                    {{ config_data.error_message }}
                {% else %}
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Last checked: {{ config_data.last_checked|timesince }} ago
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ========== QUICK ACTIONS ========== -->
    <div class="section-header">
        <i class="fas fa-bolt"></i>
        <h2>Quick Actions</h2>
    </div>

    <div class="quick-actions-grid">
        
        <!-- Manage Workspaces -->
        <a href="{% url 'companyadmin:departments' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <div class="action-content">
                <h3>Manage Workspaces</h3>
                <p>Create, edit, and organize workspaces</p>
            </div>
        </a>

        <!-- Workspace Admins -->
        <a href="{% url 'companyadmin:users' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="action-content">
                <h3>Workspace Admins</h3>
                <p>Add and assign administrators</p>
            </div>
        </a>

        <!-- IoT Devices -->
        <a href="{% url 'companyadmin:device_list' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="action-content">
                <h3>IoT Devices</h3>
                <p>Manage connected devices and sensors</p>
            </div>
        </a>

        <!-- ✨ UPDATED: InfluxDB Configuration (plural) -->
        <a href="{% url 'companyadmin:influx_config' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-database"></i>
            </div>
            <div class="action-content">
                <h3>InfluxDB Configs</h3>
                <p>Manage time-series database instances</p>
            </div>
        </a>

        <!-- Device Setup Wizard -->
        <a href="{% url 'companyadmin:device_setup_wizard' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-magic"></i>
            </div>
            <div class="action-content">
                <h3>Setup Wizard</h3>
                <p>Discover and configure new devices</p>
            </div>
        </a>

        <!-- Sensor Configuration -->
        <a href="{% url 'companyadmin:device_list' %}" class="action-card">
            <div class="action-icon">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div class="action-content">
                <h3>Sensor Metadata</h3>
                <p>Configure sensor properties and limits</p>
            </div>
        </a>

    </div>

    <!-- ========== RECENT ACTIVITY ========== -->
    <div class="section-header">
        <i class="fas fa-history"></i>
        <h2>Recent Activity</h2>
    </div>

    <div class="activity-card">
        {% if recent_activities %}
        <table class="activity-table">
            <thead>
                <tr>
                    <th style="width: 60px;"></th>
                    <th>Activity</th>
                    <th>Details</th>
                    <th style="width: 160px;">Time</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in recent_activities %}
                <tr>
                    <td class="activity-icon-cell">
                        <div class="activity-icon-wrapper" style="background: {{ activity.color }};">
                            <i class="fas {{ activity.icon }}" style="color: {{ activity.icon_color }};"></i>
                        </div>
                    </td>
                    <td>
                        <p class="activity-title">{{ activity.title }}</p>
                    </td>
                    <td>
                        <p class="activity-description">{{ activity.description }}</p>
                    </td>
                    <td>
                        <span class="activity-time">{{ activity.time|timesince }} ago</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>No recent activity in the last 7 days</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}