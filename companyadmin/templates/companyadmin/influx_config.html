{% extends 'companyadmin/base.html' %}

{% block title %}InfluxDB Configurations{% endblock %}
{% block page_heading %}InfluxDB Configurations{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   INFLUXDB CONFIGS PAGE - MULTI-INSTANCE
   PRIMARY BLUE THEME
   ======================================== */

/* ===== CONTAINER ===== */
.config-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: var(--space-6);
}

/* ===== FLOATING LABEL INPUTS ===== */
.floating-label-group {
    position: relative;
    margin-bottom: var(--space-4);
}

.floating-label-group input,
.floating-label-group textarea {
    width: 100%;
    padding: 16px 12px 8px 12px;
    font-size: 14px;
    border: 2px solid var(--border-light);
    border-radius: var(--radius-md);
    background: white;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
    color: var(--text-primary);
}

.floating-label-group label {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: var(--text-tertiary);
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    padding: 0 4px;
    font-weight: 500;
}

.floating-label-group input:focus + label,
.floating-label-group input:not(:placeholder-shown) + label,
.floating-label-group textarea:focus + label,
.floating-label-group textarea:not(:placeholder-shown) + label {
    top: 0;
    transform: translateY(-50%);
    font-size: 11px;
    color: var(--primary-blue);
    font-weight: 600;
}

.floating-label-group input:focus,
.floating-label-group textarea:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.floating-label-group label .required-mark {
    color: var(--danger);
}

/* ✅ FIXED: Password field - special handling for floating label */
.floating-label-group.password-group {
    position: relative;
}

.floating-label-group.password-group input {
    padding-right: 50px; /* Space for toggle button */
}

.floating-label-group.password-group .password-toggle-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: 8px;
    transition: color 0.2s ease;
    z-index: 10;
}

.floating-label-group.password-group .password-toggle-btn:hover {
    color: var(--primary-blue);
}

/* ✅ FIXED: Label positioning for password fields */
.floating-label-group.password-group label {
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
}

.floating-label-group.password-group input:focus ~ label,
.floating-label-group.password-group input:not(:placeholder-shown) ~ label,
.floating-label-group.password-group.has-value label {
    top: 0;
    transform: translateY(-50%);
    font-size: 11px;
    color: var(--primary-blue);
    font-weight: 600;
}

/* ===== WELCOME CARD ===== */
.welcome-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    box-shadow: var(--shadow-sm);
}

.welcome-card h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.welcome-card h3 i {
    color: var(--primary-blue);
    font-size: var(--text-2xl);
}

.welcome-card p {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin: 0;
}

.welcome-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
}

.btn-add-config {
    background: var(--primary-blue);
    color: white;
    border: none;
    padding: 12px var(--space-5);
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
}

.btn-add-config:hover {
    background: var(--primary-blue-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
}

/* ===== STATS ROW ===== */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.stat-card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
}

.stat-icon {
    width: 48px;
    height: 48px;
    background: var(--primary-blue);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon i {
    color: white;
    font-size: var(--text-xl);
}

.stat-icon.green {
    background: var(--success);
}

.stat-icon.red {
    background: var(--danger);
}

.stat-icon.orange {
    background: #f59e0b;
}

.stat-icon.indigo {
    background: #6366f1;
}

.stat-info h4 {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 4px 0;
}

.stat-info p {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

/* ===== CONFIG GRID ===== */
.configs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: var(--space-5);
    margin-bottom: var(--space-6);
}

.config-card {
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.config-card:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
}

.config-card.connected {
    border-left: 4px solid var(--success);
}

.config-card.disconnected {
    border-left: 4px solid var(--danger);
}

.config-card.untested {
    border-left: 4px solid var(--gray-400);
}

.config-card-header {
    background: var(--gray-50);
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-light);
}

.config-title {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
}

.config-title h3 {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.status-badge {
    padding: 4px var(--space-3);
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
}

.status-badge.connected {
    background: var(--success);
    color: white;
}

.status-badge.disconnected {
    background: var(--danger);
    color: white;
}

.status-badge.untested {
    background: var(--gray-400);
    color: white;
}

.config-db-name {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin: 0;
}

.config-card-body {
    padding: var(--space-5);
}

.config-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--border-light);
}

.config-info-row:last-child {
    border-bottom: none;
}

.config-info-label {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.config-info-label i {
    color: var(--primary-blue);
    width: 16px;
}

.config-info-value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
}

.config-card-footer {
    padding: var(--space-4);
    background: var(--gray-50);
    border-top: 1px solid var(--border-light);
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-2);
}

.btn-config-action {
    padding: 10px var(--space-3);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.btn-config-action:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-test {
    background: var(--success);
    color: white;
}

.btn-test:hover {
    background: #059669;
}

.btn-edit {
    background: var(--primary-blue);
    color: white;
}

.btn-edit:hover {
    background: var(--primary-blue-dark);
}

.btn-delete {
    background: var(--danger);
    color: white;
}

.btn-delete:hover {
    background: #991b1b;
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 100px 40px;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 2px dashed var(--border-medium);
}

.empty-icon {
    width: 100px;
    height: 100px;
    background: var(--primary-blue);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-5);
}

.empty-icon i {
    font-size: 48px;
    color: white;
}

.empty-state h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-3);
}

.empty-state p {
    font-size: var(--text-base);
    color: var(--text-secondary);
    margin-bottom: var(--space-5);
}

/* ===== MODAL STYLES ===== */
.modal-header {
    background: var(--primary-blue);
    color: white;
    border-bottom: none;
    padding: var(--space-5);
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.modal-header .modal-title {
    font-weight: 600;
    font-size: var(--text-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.modal-body {
    padding: var(--space-6);
}

.modal-footer {
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--border-light);
}

.modal-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-4);
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--gray-50);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: var(--space-4);
}

.checkbox-container:hover {
    border-color: var(--primary-blue);
    background: white;
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--primary-blue);
}

.checkbox-container label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    margin: 0;
}

.btn-primary-submit {
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    padding: 12px var(--space-5);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    cursor: pointer;
}

.btn-primary-submit:hover {
    background: var(--primary-blue-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .config-container {
        padding: var(--space-4);
    }
    
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .configs-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-form-grid {
        grid-template-columns: 1fr;
    }
    
    .config-card-footer {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="config-container">

    <!-- ========== WELCOME CARD ========== -->
    <div class="welcome-card">
        <div class="welcome-card-header">
            <div>
                <h3>
                    <i class="fas fa-database"></i>
                    InfluxDB Configurations
                </h3>
                <p>Manage multiple time-series database instances for your IoT data</p>
            </div>
            <button type="button" class="btn-add-config" data-bs-toggle="modal" data-bs-target="#createModal">
                <i class="fas fa-plus-circle"></i>
                Add Configuration
            </button>
        </div>
    </div>

    <!-- ========== STATS ROW ========== -->
    {% if has_configs %}
    <div class="stats-row">
        <!-- Total Configs -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-info">
                    <h4>Total Instances</h4>
                    <p>{{ total_configs }}</p>
                </div>
            </div>
        </div>

        <!-- Connected -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon green">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h4>Connected</h4>
                    <p>{{ connected_configs }}</p>
                </div>
            </div>
        </div>

        <!-- Disconnected -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon red">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-info">
                    <h4>Disconnected</h4>
                    <p>{{ disconnected_configs }}</p>
                </div>
            </div>
        </div>

        <!-- Total Devices -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon orange">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-info">
                    <h4>Total Devices</h4>
                    <p>{{ total_devices }}</p>
                </div>
            </div>
        </div>

        <!-- Total Sensors -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon indigo">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="stat-info">
                    <h4>Total Sensors</h4>
                    <p>{{ total_sensors }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========== CONFIGS GRID ========== -->
    {% if has_configs %}
    <div class="configs-grid">
        {% for config_data in configs_data %}
        <div class="config-card {% if config_data.config.is_connected %}connected{% elif config_data.config.last_tested_at %}disconnected{% else %}untested{% endif %}">
            
            <!-- Card Header -->
            <div class="config-card-header">
                <div class="config-title">
                    <h3>{{ config_data.config.config_name }}</h3>
                    <span class="status-badge {% if config_data.config.is_connected %}connected{% elif config_data.config.last_tested_at %}disconnected{% else %}untested{% endif %}">
                        {% if config_data.config.is_connected %}
                            <i class="fas fa-check-circle"></i> Online
                        {% elif config_data.config.last_tested_at %}
                            <i class="fas fa-times-circle"></i> Offline
                        {% else %}
                            <i class="fas fa-question-circle"></i> Untested
                        {% endif %}
                    </span>
                </div>
                <p class="config-db-name">
                    <i class="fas fa-database"></i> {{ config_data.config.db_name }}
                </p>
            </div>

            <!-- Card Body -->
            <div class="config-card-body">
                <div class="config-info-row">
                    <span class="config-info-label">
                        <i class="fas fa-link"></i> API Endpoint
                    </span>
                    <span class="config-info-value">{{ config_data.config.base_api|truncatechars:30 }}</span>
                </div>

                <div class="config-info-row">
                    <span class="config-info-label">
                        <i class="fas fa-user"></i> Username
                    </span>
                    <span class="config-info-value">{{ config_data.config.api_username }}</span>
                </div>

                <div class="config-info-row">
                    <span class="config-info-label">
                        <i class="fas fa-microchip"></i> Devices
                    </span>
                    <span class="config-info-value">{{ config_data.device_count }}</span>
                </div>

                <div class="config-info-row">
                    <span class="config-info-label">
                        <i class="fas fa-sliders-h"></i> Sensors
                    </span>
                    <span class="config-info-value">{{ config_data.sensor_count }}</span>
                </div>

                <div class="config-info-row">
                    <span class="config-info-label">
                        <i class="fas fa-clock"></i> Last Tested
                    </span>
                    <span class="config-info-value">
                        {% if config_data.config.last_tested_at %}
                            {{ config_data.config.last_tested_at|timesince }} ago
                        {% else %}
                            Never
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Card Footer - Actions -->
            <div class="config-card-footer">
                <!-- Test Connection -->
                <button type="button" class="btn-config-action btn-test" 
                        data-config-id="{{ config_data.config.id }}" 
                        data-config-name="{{ config_data.config.config_name }}"
                        onclick="handleTestConnection(this)">
                    <i class="fas fa-plug"></i> Test
                </button>

                <!-- Edit -->
                <button type="button" class="btn-config-action btn-edit" 
                        data-config-id="{{ config_data.config.id }}"
                        onclick="handleEditConfig(this)">
                    <i class="fas fa-edit"></i> Edit
                </button>

                <!-- Delete -->
                <button type="button" class="btn-config-action btn-delete" 
                        data-config-id="{{ config_data.config.id }}" 
                        data-config-name="{{ config_data.config.config_name }}"
                        data-device-count="{{ config_data.device_count }}"
                        onclick="handleDeleteConfig(this)">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>

        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- ========== EMPTY STATE ========== -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-database"></i>
        </div>
        <h3>No InfluxDB Configurations</h3>
        <p>Create your first InfluxDB configuration to start collecting sensor data</p>
        <button type="button" class="btn-primary-submit" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="fas fa-plus-circle"></i>
            Create Configuration
        </button>
    </div>
    {% endif %}

</div>

<!-- ========== CREATE MODAL ========== -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="create_config" value="1">
                
                <div class="modal-header">
                    <h6 class="modal-title">
                        <i class="fas fa-plus-circle"></i>
                        Create InfluxDB Configuration
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="modal-form-grid">
                        <!-- Config Name -->
                        <div class="floating-label-group">
                            <input type="text" name="config_name" id="create_config_name" placeholder=" " required>
                            <label for="create_config_name">Configuration Name <span class="required-mark">*</span></label>
                        </div>

                        <!-- Database Name -->
                        <div class="floating-label-group">
                            <input type="text" name="db_name" id="create_db_name" placeholder=" " required>
                            <label for="create_db_name">Database Name <span class="required-mark">*</span></label>
                        </div>

                        <!-- API Endpoint -->
                        <div class="floating-label-group">
                            <input type="url" name="base_api" id="create_base_api" placeholder=" " required>
                            <label for="create_base_api">API Endpoint <span class="required-mark">*</span></label>
                        </div>

                        <!-- Username -->
                        <div class="floating-label-group">
                            <input type="text" name="api_username" id="create_api_username" placeholder=" " required>
                            <label for="create_api_username">Username <span class="required-mark">*</span></label>
                        </div>

                        <!-- ✅ FIXED: Password field with proper floating label -->
                        <div class="floating-label-group password-group">
                            <input type="password" name="api_password" id="create_api_password" placeholder=" " required>
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('create_api_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                            <label for="create_api_password">Password <span class="required-mark">*</span></label>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="floating-label-group">
                        <textarea name="notes" id="create_notes" rows="3" placeholder=" "></textarea>
                        <label for="create_notes">Notes (Optional)</label>
                    </div>

                    <!-- Active -->
                    <div class="checkbox-container">
                        <input type="checkbox" name="is_active" id="create_is_active" checked>
                        <label for="create_is_active">Configuration Active</label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn-primary-submit">
                        <i class="fas fa-save"></i> Create Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========== EDIT MODAL ========== -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" id="editForm">
                {% csrf_token %}
                <input type="hidden" name="edit_config" value="1">
                <input type="hidden" name="config_id" id="edit_config_id">
                
                <div class="modal-header">
                    <h6 class="modal-title">
                        <i class="fas fa-edit"></i>
                        Edit InfluxDB Configuration
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="modal-form-grid">
                        <!-- Config Name -->
                        <div class="floating-label-group">
                            <input type="text" name="config_name" id="edit_config_name" placeholder=" " required>
                            <label for="edit_config_name">Configuration Name <span class="required-mark">*</span></label>
                        </div>

                        <!-- Database Name -->
                        <div class="floating-label-group">
                            <input type="text" name="db_name" id="edit_db_name" placeholder=" " required>
                            <label for="edit_db_name">Database Name <span class="required-mark">*</span></label>
                        </div>

                        <!-- API Endpoint -->
                        <div class="floating-label-group">
                            <input type="url" name="base_api" id="edit_base_api" placeholder=" " required>
                            <label for="edit_base_api">API Endpoint <span class="required-mark">*</span></label>
                        </div>

                        <!-- Username -->
                        <div class="floating-label-group">
                            <input type="text" name="api_username" id="edit_api_username" placeholder=" " required>
                            <label for="edit_api_username">Username <span class="required-mark">*</span></label>
                        </div>

                        <!-- ✅ FIXED: Password field with proper floating label -->
                        <div class="floating-label-group password-group">
                            <input type="password" name="api_password" id="edit_api_password" placeholder=" ">
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('edit_api_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                            <label for="edit_api_password">Password (leave blank to keep current)</label>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="floating-label-group">
                        <textarea name="notes" id="edit_notes" rows="3" placeholder=" "></textarea>
                        <label for="edit_notes">Notes (Optional)</label>
                    </div>

                    <!-- Active -->
                    <div class="checkbox-container">
                        <input type="checkbox" name="is_active" id="edit_is_active">
                        <label for="edit_is_active">Configuration Active</label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn-primary-submit">
                        <i class="fas fa-save"></i> Update Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========== HIDDEN FORMS ========== -->
<form method="POST" id="testForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="test_connection" value="1">
    <input type="hidden" name="config_id" id="test_config_id">
</form>

<form method="POST" id="deleteForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="delete_config" value="1">
    <input type="hidden" name="config_id" id="delete_config_id">
</form>

{% endblock %}

{% block extra_js %}
<script>
// Config data as JavaScript object
const configsData = [
    {% for config_data in configs_data %}
    {
        id: {{ config_data.config.id }},
        config_name: "{{ config_data.config.config_name|escapejs }}",
        db_name: "{{ config_data.config.db_name|escapejs }}",
        base_api: "{{ config_data.config.base_api|escapejs }}",
        api_username: "{{ config_data.config.api_username|escapejs }}",
        api_password: "{{ config_data.config.api_password|escapejs }}",
        notes: "{{ config_data.config.notes|default:''|escapejs }}",
        is_active: {{ config_data.config.is_active|yesno:"true,false" }},
        device_count: {{ config_data.device_count }},
        sensor_count: {{ config_data.sensor_count }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// ✅ FIXED: Password toggle function - simplified
function togglePasswordVisibility(fieldId, button) {
    const field = document.getElementById(fieldId);
    const icon = button.querySelector('i');
    
    if (!field || !icon) {
        console.error('Password field or icon not found:', fieldId);
        return;
    }
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Test connection handler
function handleTestConnection(button) {
    const configId = button.getAttribute('data-config-id');
    const configName = button.getAttribute('data-config-name');
    
    if (!configId) {
        console.error('Config ID not found');
        return;
    }
    
    if (confirm(`Test connection for "${configName}"?\n\nThis will verify your database credentials and connectivity.`)) {
        document.getElementById('test_config_id').value = configId;
        
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        
        document.getElementById('testForm').submit();
    }
}

// Edit config handler
function handleEditConfig(button) {
    const configId = button.getAttribute('data-config-id');
    
    if (!configId) {
        console.error('Config ID not found');
        return;
    }
    
    // Find config in data array
    const config = configsData.find(c => c.id == configId);
    
    if (!config) {
        console.error('Config not found in data:', configId);
        alert('Configuration data not found. Please refresh the page.');
        return;
    }
    
    // Populate edit form
    document.getElementById('edit_config_id').value = config.id;
    document.getElementById('edit_config_name').value = config.config_name;
    document.getElementById('edit_db_name').value = config.db_name;
    document.getElementById('edit_base_api').value = config.base_api;
    document.getElementById('edit_api_username').value = config.api_username;
    document.getElementById('edit_api_password').value = ''; // Don't pre-fill password
    document.getElementById('edit_notes').value = config.notes || '';
    document.getElementById('edit_is_active').checked = config.is_active;
    
    // ✅ Trigger label float for pre-filled fields
    setTimeout(function() {
        triggerFloatLabels('editModal');
    }, 100);
    
    // Show modal
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    editModal.show();
}

// ✅ NEW: Function to trigger floating labels on pre-filled inputs
function triggerFloatLabels(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    const inputs = modal.querySelectorAll('.floating-label-group input, .floating-label-group textarea');
    inputs.forEach(input => {
        // Trigger the focus/blur to activate floating label
        if (input.value && input.value.trim() !== '') {
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }
    });
}

// Delete config handler
function handleDeleteConfig(button) {
    const configId = button.getAttribute('data-config-id');
    const configName = button.getAttribute('data-config-name');
    const deviceCount = parseInt(button.getAttribute('data-device-count')) || 0;
    
    if (!configId) {
        console.error('Config ID not found');
        return;
    }
    
    // Check if config has devices
    if (deviceCount > 0) {
        alert(`Cannot delete "${configName}" - it has ${deviceCount} associated devices.\n\nPlease reassign or delete those devices first.`);
        return;
    }
    
    if (confirm(`Delete configuration "${configName}"?\n\nThis action cannot be undone.`)) {
        document.getElementById('delete_config_id').value = configId;
        
        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        document.getElementById('deleteForm').submit();
    }
}

// Form submission protection
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            
            if (submitBtn && !submitBtn.disabled) {
                submitBtn.disabled = true;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                // Re-enable after timeout (fallback)
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }, 10000);
            }
        });
    });
    
    // ✅ Reset password toggle icons when modals are closed
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            const passwordFields = modal.querySelectorAll('input[type="text"][name="api_password"]');
            passwordFields.forEach(field => {
                field.type = 'password';
            });
            
            const eyeIcons = modal.querySelectorAll('.password-toggle-btn i');
            eyeIcons.forEach(icon => {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            });
        });
    });
});
</script>
{% endblock %}