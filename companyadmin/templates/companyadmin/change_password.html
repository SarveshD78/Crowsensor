{% extends 'companyadmin/base.html' %}

{% block title %}Change Password{% endblock %}
{% block page_heading %}Change Password{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   CHANGE PASSWORD PAGE
   Uses base.html design system
   ======================================== */

.password-container {
    max-width: 600px;
    margin: 0 auto;
}

/* ===== SECURITY NOTICE ===== */
.security-notice {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-6);
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
}

.security-notice-icon {
    width: 48px;
    height: 48px;
    background: #f59e0b;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.security-notice-icon i {
    font-size: 24px;
    color: white;
}

.security-notice-content h3 {
    font-size: var(--text-base);
    font-weight: 700;
    color: #92400e;
    margin: 0 0 var(--space-2) 0;
}

.security-notice-content p {
    font-size: var(--text-sm);
    color: #a16207;
    margin: 0;
    line-height: 1.5;
}

/* ===== PASSWORD CARD ===== */
.password-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.password-card-header {
    background: var(--gray-50);
    padding: var(--space-5);
    border-bottom: 1px solid var(--border-light);
}

.password-card-header h2 {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.password-card-header h2 i {
    color: var(--primary-blue);
}

.password-card-body {
    padding: var(--space-6);
}

/* ===== FORM STYLES ===== */
.form-group {
    margin-bottom: var(--space-5);
}

.form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
}

.form-label i {
    color: var(--primary-blue);
    margin-right: var(--space-2);
    width: 16px;
    text-align: center;
}

.form-label .required {
    color: var(--danger);
    margin-left: 4px;
}

/* ===== PASSWORD INPUT WITH TOGGLE ===== */
.password-input-wrapper {
    position: relative;
}

.form-control-password {
    width: 100%;
    padding: var(--space-4) 50px var(--space-4) var(--space-4);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: var(--font-family);
    color: var(--text-primary);
    background: white;
    transition: all 0.2s ease;
    letter-spacing: 1px;
}

.form-control-password:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-control-password.is-invalid {
    border-color: var(--danger);
}

.form-control-password.is-valid {
    border-color: var(--success);
}

.form-control-password::placeholder {
    font-family: var(--font-family);
    letter-spacing: normal;
    color: var(--text-muted);
}

.password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: var(--space-2);
    font-size: 18px;
    transition: color 0.2s ease;
}

.password-toggle:hover {
    color: var(--primary-blue);
}

/* ===== PASSWORD STRENGTH METER ===== */
.password-strength {
    margin-top: var(--space-3);
}

.strength-bar-container {
    height: 6px;
    background: var(--gray-200);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: var(--space-2);
}

.strength-bar {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
    border-radius: 3px;
}

.strength-bar.weak {
    width: 25%;
    background: var(--danger);
}

.strength-bar.fair {
    width: 50%;
    background: var(--warning);
}

.strength-bar.good {
    width: 75%;
    background: #22c55e;
}

.strength-bar.strong {
    width: 100%;
    background: #16a34a;
}

.strength-text {
    font-size: var(--text-xs);
    font-weight: 600;
}

.strength-text.weak { color: var(--danger); }
.strength-text.fair { color: var(--warning); }
.strength-text.good { color: #22c55e; }
.strength-text.strong { color: #16a34a; }

/* ===== PASSWORD REQUIREMENTS ===== */
.password-requirements {
    background: var(--gray-50);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-top: var(--space-4);
}

.password-requirements h4 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 var(--space-3) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.password-requirements h4 i {
    color: var(--primary-blue);
}

.requirement-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.requirement-list li {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    padding: var(--space-1) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    transition: all 0.2s ease;
}

.requirement-list li i {
    width: 16px;
    font-size: 12px;
}

.requirement-list li.met {
    color: var(--success);
}

.requirement-list li.met i {
    color: var(--success);
}

.requirement-list li.unmet i {
    color: var(--gray-400);
}

/* ===== MATCH INDICATOR ===== */
.match-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-2);
    font-size: var(--text-sm);
    font-weight: 500;
}

.match-indicator.match {
    color: var(--success);
}

.match-indicator.no-match {
    color: var(--danger);
}

/* ===== BUTTONS ===== */
.btn-row {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-6);
    padding-top: var(--space-5);
    border-top: 1px solid var(--border-light);
}

.btn-primary-password {
    background: var(--primary-blue);
    color: white;
    border: none;
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-family: var(--font-family);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    flex: 1;
    justify-content: center;
}

.btn-primary-password:hover:not(:disabled) {
    background: var(--primary-blue-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-primary-password:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary-password {
    background: white;
    color: var(--text-primary);
    border: 2px solid var(--border-medium);
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-family: var(--font-family);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    text-decoration: none;
    justify-content: center;
}

.btn-secondary-password:hover {
    background: var(--gray-50);
    border-color: var(--primary-blue);
    color: var(--primary-blue);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .security-notice {
        flex-direction: column;
        text-align: center;
    }
    
    .security-notice-icon {
        margin: 0 auto;
    }
    
    .btn-row {
        flex-direction: column;
    }
    
    .btn-row button,
    .btn-row a {
        width: 100%;
    }
    
    .password-card-body {
        padding: var(--space-4);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="password-container">

    <!-- Security Notice -->
    <div class="security-notice">
        <div class="security-notice-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <div class="security-notice-content">
            <h3>Security Notice</h3>
            <p>Choose a strong password that you don't use elsewhere. After changing your password, you'll remain logged in on this device.</p>
        </div>
    </div>

    <!-- Password Change Card -->
    <div class="password-card">
        <div class="password-card-header">
            <h2>
                <i class="fas fa-key"></i>
                Update Your Password
            </h2>
        </div>
        <div class="password-card-body">
            <form method="POST" id="passwordForm">
                {% csrf_token %}
                
                <!-- Current Password -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-lock"></i>
                        Current Password <span class="required">*</span>
                    </label>
                    <div class="password-input-wrapper">
                        <input type="password" 
                               name="current_password" 
                               id="current_password"
                               class="form-control-password" 
                               placeholder="Enter current password"
                               required
                               autocomplete="current-password">
                        <button type="button" class="password-toggle" data-target="current_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <!-- New Password -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-key"></i>
                        New Password <span class="required">*</span>
                    </label>
                    <div class="password-input-wrapper">
                        <input type="password" 
                               name="new_password" 
                               id="new_password"
                               class="form-control-password" 
                               placeholder="Enter new password"
                               required
                               autocomplete="new-password">
                        <button type="button" class="password-toggle" data-target="new_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Password Strength Meter -->
                    <div class="password-strength">
                        <div class="strength-bar-container">
                            <div class="strength-bar" id="strengthBar"></div>
                        </div>
                        <span class="strength-text" id="strengthText"></span>
                    </div>
                </div>
                
                <!-- Confirm Password -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-check-double"></i>
                        Confirm New Password <span class="required">*</span>
                    </label>
                    <div class="password-input-wrapper">
                        <input type="password" 
                               name="confirm_password" 
                               id="confirm_password"
                               class="form-control-password" 
                               placeholder="Confirm new password"
                               required
                               autocomplete="new-password">
                        <button type="button" class="password-toggle" data-target="confirm_password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Match Indicator -->
                    <div class="match-indicator" id="matchIndicator" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Passwords match</span>
                    </div>
                </div>
                
                <!-- Password Requirements -->
                <div class="password-requirements">
                    <h4>
                        <i class="fas fa-list-check"></i>
                        Password Requirements
                    </h4>
                    <ul class="requirement-list">
                        <li class="unmet" id="req-length">
                            <i class="fas fa-circle"></i>
                            At least 8 characters
                        </li>
                        <li class="unmet" id="req-uppercase">
                            <i class="fas fa-circle"></i>
                            At least one uppercase letter (A-Z)
                        </li>
                        <li class="unmet" id="req-lowercase">
                            <i class="fas fa-circle"></i>
                            At least one lowercase letter (a-z)
                        </li>
                        <li class="unmet" id="req-number">
                            <i class="fas fa-circle"></i>
                            At least one number (0-9)
                        </li>
                        <li class="unmet" id="req-special">
                            <i class="fas fa-circle"></i>
                            At least one special character (!@#$%^&*)
                        </li>
                    </ul>
                </div>
                
                <!-- Buttons -->
                <div class="btn-row">
                    <a href="{% url 'companyadmin:profile' %}" class="btn-secondary-password">
                        <i class="fas fa-arrow-left"></i>
                        Back to Profile
                    </a>
                    <button type="submit" class="btn-primary-password" id="submitBtn">
                        <i class="fas fa-save"></i>
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const matchIndicator = document.getElementById('matchIndicator');
    const submitBtn = document.getElementById('submitBtn');
    
    // Requirements elements
    const reqLength = document.getElementById('req-length');
    const reqUppercase = document.getElementById('req-uppercase');
    const reqLowercase = document.getElementById('req-lowercase');
    const reqNumber = document.getElementById('req-number');
    const reqSpecial = document.getElementById('req-special');
    
    // Password toggle visibility
    document.querySelectorAll('.password-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
    });
    
    // Update requirement status
    function updateRequirement(element, met) {
        if (met) {
            element.classList.remove('unmet');
            element.classList.add('met');
            element.querySelector('i').className = 'fas fa-check-circle';
        } else {
            element.classList.remove('met');
            element.classList.add('unmet');
            element.querySelector('i').className = 'fas fa-circle';
        }
    }
    
    // Check password strength
    function checkPasswordStrength(password) {
        let strength = 0;
        const checks = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Update requirements
        updateRequirement(reqLength, checks.length);
        updateRequirement(reqUppercase, checks.uppercase);
        updateRequirement(reqLowercase, checks.lowercase);
        updateRequirement(reqNumber, checks.number);
        updateRequirement(reqSpecial, checks.special);
        
        // Calculate strength
        Object.values(checks).forEach(check => {
            if (check) strength++;
        });
        
        // Update strength bar
        strengthBar.className = 'strength-bar';
        strengthText.className = 'strength-text';
        
        if (password.length === 0) {
            strengthBar.style.width = '0%';
            strengthText.textContent = '';
        } else if (strength <= 2) {
            strengthBar.classList.add('weak');
            strengthText.classList.add('weak');
            strengthText.textContent = 'Weak';
        } else if (strength === 3) {
            strengthBar.classList.add('fair');
            strengthText.classList.add('fair');
            strengthText.textContent = 'Fair';
        } else if (strength === 4) {
            strengthBar.classList.add('good');
            strengthText.classList.add('good');
            strengthText.textContent = 'Good';
        } else {
            strengthBar.classList.add('strong');
            strengthText.classList.add('strong');
            strengthText.textContent = 'Strong';
        }
        
        return strength >= 3;
    }
    
    // Check password match
    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword.length === 0) {
            matchIndicator.style.display = 'none';
            confirmPasswordInput.classList.remove('is-valid', 'is-invalid');
            return false;
        }
        
        if (newPassword === confirmPassword) {
            matchIndicator.style.display = 'flex';
            matchIndicator.className = 'match-indicator match';
            matchIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Passwords match</span>';
            confirmPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.add('is-valid');
            return true;
        } else {
            matchIndicator.style.display = 'flex';
            matchIndicator.className = 'match-indicator no-match';
            matchIndicator.innerHTML = '<i class="fas fa-times-circle"></i><span>Passwords do not match</span>';
            confirmPasswordInput.classList.remove('is-valid');
            confirmPasswordInput.classList.add('is-invalid');
            return false;
        }
    }
    
    // Event listeners
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    
    // Form submission
    const form = document.getElementById('passwordForm');
    form.addEventListener('submit', function(e) {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Check minimum requirements
        if (newPassword.length < 8) {
            e.preventDefault();
            alert('Password must be at least 8 characters long.');
            return false;
        }
        
        // Check match
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Passwords do not match.');
            return false;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
    });
});
</script>
{% endblock %}